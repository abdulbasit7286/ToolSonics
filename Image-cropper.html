<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Quick Crop Test</title>
  <style>
    body{font-family:sans-serif;padding:18px;background:#f6fbff}
    .card{max-width:900px;margin:auto;background:#fff;padding:16px;border-radius:10px}
    .preview{width:100%;height:400px;border:1px solid #ddd;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
    .preview img{max-width:100%;max-height:100%;object-fit:contain}
    .crop{position:absolute;border:2px dashed #0d6efd;background:rgba(13,110,253,0.06);width:200px;height:150px;left:50px;top:40px}
    .controls{margin-top:10px;display:flex;gap:8px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Quick Crop Test</h2>
    <input id="file" type="file" accept="image/*"><br>
    <div class="preview" id="pv"><span style="color:#666">Preview</span></div>
    <div class="controls">
      <button id="cropBtn">Crop & Download</button>
      <button id="reset">Reset</button>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('file');
    const pv = document.getElementById('pv');
    const cropBtn = document.getElementById('cropBtn');
    const resetBtn = document.getElementById('reset');
    let imgEl=null, cropEl=null, blobUrl=null;

    fileInput.addEventListener('change', e=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      if(blobUrl){ URL.revokeObjectURL(blobUrl); blobUrl=null; }
      blobUrl = URL.createObjectURL(f);
      pv.innerHTML = '';
      imgEl = new Image();
      imgEl.src = blobUrl;
      imgEl.onload = ()=> {
        pv.appendChild(imgEl);
        // add simple crop box if not exists
        if(!cropEl){
          cropEl = document.createElement('div');
          cropEl.className='crop';
          pv.appendChild(cropEl);
          // allow dragging the crop box (simple)
          let drag=false, startX, startY, sx, sy;
          cropEl.addEventListener('mousedown', e=>{
            drag=true; startX=e.clientX; startY=e.clientY; const r=cropEl.getBoundingClientRect(); sx=r.left; sy=r.top;
            e.preventDefault();
          });
          window.addEventListener('mousemove', e=>{
            if(!drag) return;
            const dx = e.clientX - startX, dy = e.clientY - startY;
            const pvRect = pv.getBoundingClientRect();
            let nx = sx + dx - pvRect.left;
            let ny = sy + dy - pvRect.top;
            nx = Math.max(0, Math.min(nx, pv.clientWidth - cropEl.offsetWidth));
            ny = Math.max(0, Math.min(ny, pv.clientHeight - cropEl.offsetHeight));
            cropEl.style.left = nx + 'px'; cropEl.style.top = ny + 'px';
          });
          window.addEventListener('mouseup', ()=> drag=false);
        }
      };
    });

    cropBtn.addEventListener('click', async ()=>{
      if(!imgEl || !cropEl) { alert('Upload image and adjust box'); return; }
      // map crop box from preview space to natural image pixels
      const imgRect = imgEl.getBoundingClientRect();
      const pvRect = pv.getBoundingClientRect();
      const sx_rel = cropEl.offsetLeft - (imgRect.left - pvRect.left);
      const sy_rel = cropEl.offsetTop - (imgRect.top - pvRect.top);
      const scaleX = imgEl.naturalWidth / imgRect.width;
      const scaleY = imgEl.naturalHeight / imgRect.height;
      const sx = Math.round(Math.max(0, sx_rel) * scaleX);
      const sy = Math.round(Math.max(0, sy_rel) * scaleY);
      const sw = Math.round(cropEl.offsetWidth * scaleX);
      const sh = Math.round(cropEl.offsetHeight * scaleY);
      const canvas = document.createElement('canvas');
      canvas.width = sw; canvas.height = sh;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(imgEl, sx, sy, sw, sh, 0, 0, sw, sh);
      canvas.toBlob(b=>{
        const u = URL.createObjectURL(b);
        const a = document.createElement('a');
        a.href = u; a.download = 'crop.png'; a.click();
        setTimeout(()=>URL.revokeObjectURL(u),5000);
      }, 'image/png');
    });

    resetBtn.addEventListener('click', ()=>{
      if(blobUrl) try{ URL.revokeObjectURL(blobUrl);}catch(e){}
      blobUrl=null; imgEl=null; cropEl=null; pv.innerHTML = '<span style="color:#666">Preview</span>'; fileInput.value='';
    });
  </script>
</body>
</html>
